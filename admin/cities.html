<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>QuickPress | City & Hub Management</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="../assets/ui.css">

<style>
.container{max-width:1200px;margin:auto;padding:16px}
.topbar{
  background:#FFD84D;padding:14px 16px;border-radius:14px;
  display:flex;justify-content:space-between;align-items:center
}
.grid{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(260px,1fr));
  gap:16px;margin-top:16px
}
.card h3{margin-bottom:8px}
input,select{
  width:100%;padding:8px;margin:6px 0;
  border-radius:8px;border:1px solid #ddd
}
button{margin-top:8px}
.city-card{
  border:1px solid #eee;border-radius:14px;
  padding:14px;background:#fff
}
.switch{
  display:flex;align-items:center;gap:8px;margin-top:6px
}
.switch input{width:auto}
.small{font-size:12px;color:#777}
</style>
</head>

<body>

<div class="container">

  <!-- TOP BAR -->
  <div class="topbar">
    <b>üèôÔ∏è City & Hub Management (Advanced)</b>
    <a href="dashboard.html">‚¨Ö Dashboard</a>
  </div>

  <!-- ADD CITY -->
  <div class="card">
    <h3>Add New City</h3>
    <input id="cityName" placeholder="City name">
    <input id="hubName" placeholder="Hub name">
    <input id="baseCharge" type="number" placeholder="Base delivery charge">
    <input id="perKm" type="number" placeholder="Charge per KM">
    <button onclick="addCity()">Add City</button>
  </div>

  <!-- CITY LIST -->
  <div class="grid" id="cityList">
    <div>Loading cities...</div>
  </div>

</div>

<!-- GLOBAL UI -->
<script src="../assets/ui.js"></script>

<!-- FIREBASE -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js";
import {
  getFirestore,
  collection,
  addDoc,
  getDocs,
  updateDoc,
  doc,
  getDoc
} from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";

/* CONFIG */
const app = initializeApp({
  apiKey:"AIzaSyCqrOXjuQIgfSKS7_YBb_ft-Z6ubsGpAqs",
  authDomain:"quickpress-e486d.firebaseapp.com",
  projectId:"quickpress-e486d"
});
const auth = getAuth(app);
const db = getFirestore(app);

/* SESSION GUARD */
onAuthStateChanged(auth, async (user)=>{
  if(!user){ location.replace("login.html"); return; }
  const snap = await getDoc(doc(db,"users",user.uid));
  if(!snap.exists() || snap.data().role!=="admin"){
    await signOut(auth);
    location.replace("login.html");
    return;
  }
  loadCities();
});

/* ADD CITY */
window.addCity = async ()=>{
  const name = cityName.value.trim();
  const hub = hubName.value.trim();
  const base = Number(baseCharge.value);
  const km = Number(perKm.value);

  if(!name || !hub) return toast("Fill all fields","error");

  showLoader();
  await addDoc(collection(db,"cities"),{
    name,
    hub,
    baseCharge: base,
    perKm: km,
    active:true,
    createdAt: new Date()
  });
  hideLoader();
  toast("City added","success");
  cityName.value=hubName.value=baseCharge.value=perKm.value="";
  loadCities();
};

/* LOAD CITIES */
async function loadCities(){
  showLoader();
  const snap = await getDocs(collection(db,"cities"));
  const wrap = document.getElementById("cityList");
  wrap.innerHTML="";
  snap.forEach(d=>{
    const c=d.data();
    wrap.innerHTML+=`
      <div class="city-card">
        <h3>${c.name}</h3>
        <div class="small">Hub: ${c.hub}</div>

        <label>Base Charge</label>
        <input type="number" value="${c.baseCharge}"
          onchange="update('${d.id}','baseCharge',this.value)">

        <label>Per KM Charge</label>
        <input type="number" value="${c.perKm}"
          onchange="update('${d.id}','perKm',this.value)">

        <div class="switch">
          <input type="checkbox" ${c.active?"checked":""}
            onchange="toggle('${d.id}',this.checked)">
          <span>${c.active?"Active":"Inactive"}</span>
        </div>
      </div>
    `;
  });
  hideLoader();
}

/* UPDATE FIELD */
window.update = async (id,field,value)=>{
  await updateDoc(doc(db,"cities",id),{
    [field]: Number(value)
  });
  toast("Updated","success");
};

/* TOGGLE CITY */
window.toggle = async (id,val)=>{
  await updateDoc(doc(db,"cities",id),{
    active: val
  });
  toast(val?"City enabled":"City disabled","success");
};
</script>

</body>
</html>
