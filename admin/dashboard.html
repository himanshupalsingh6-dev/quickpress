<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>QuickPress | Admin Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- GLOBAL UI -->
<link rel="stylesheet" href="../assets/ui.css">

<style>
.container{max-width:1200px;margin:0 auto;padding:16px}
.topbar{
  background:#FFD84D;padding:14px 16px;border-radius:14px;
  display:flex;justify-content:space-between;align-items:center;
}
.grid{
  display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
  gap:16px;margin-top:16px
}
.card h3{font-size:14px;color:#777;margin-bottom:6px}
.card .num{font-size:28px;font-weight:800}
.actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:18px}
.actions a{
  background:#fff;border-radius:12px;padding:12px 14px;
  box-shadow:var(--shadow);text-decoration:none;color:#111;font-weight:700
}
.table-card{margin-top:20px}
table{width:100%}
th{color:#777;font-size:13px}
</style>
</head>

<body>

<div class="container">

  <!-- TOP BAR -->
  <div class="topbar">
    <div><b>ğŸ‘‘ Admin Dashboard</b></div>
    <button onclick="logout()">Logout</button>
  </div>

  <!-- STATS -->
  <div class="grid">
    <div class="card">
      <h3>Total Users</h3>
      <div class="num" id="usersCount">0</div>
    </div>
    <div class="card">
      <h3>Total Orders</h3>
      <div class="num" id="ordersCount">0</div>
    </div>
    <div class="card">
      <h3>Completed Orders</h3>
      <div class="num" id="completedCount">0</div>
    </div>
    <div class="card">
      <h3>Total Revenue</h3>
      <div class="num">â‚¹<span id="revenue">0</span></div>
    </div>
  </div>

  <!-- QUICK LINKS -->
  <div class="actions">
    <a href="orders.html">ğŸ“¦ Orders</a>
    <a href="users.html">ğŸ‘¥ Users</a>
    <a href="partners.html">ğŸª Partners</a>
    <a href="riders.html">ğŸš´ Riders</a>
    <a href="payouts.html">ğŸ’° Payouts</a>
    <a href="cities.html">ğŸ™ï¸ Cities</a>
    <a href="settings.html">âš™ï¸ Settings</a>
  </div>

  <!-- RECENT ORDERS -->
  <div class="card table-card">
    <h3>Recent Orders</h3>
    <table>
      <thead>
        <tr>
          <th>Order</th>
          <th>Status</th>
          <th>Total</th>
        </tr>
      </thead>
      <tbody id="recentOrders">
        <tr><td colspan="3">Loading...</td></tr>
      </tbody>
    </table>
  </div>

</div>

<!-- GLOBAL UI -->
<script src="../assets/ui.js"></script>

<!-- FIREBASE + AUTH (SESSION GUARD INCLUDED) -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js";
import {
  getFirestore, collection, getDocs, query, orderBy, limit, doc, getDoc
} from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";

/* CONFIG */
const app = initializeApp({
  apiKey:"AIzaSyCqrOXjuQIgfSKS7_YBb_ft-Z6ubsGpAqs",
  authDomain:"quickpress-e486d.firebaseapp.com",
  projectId:"quickpress-e486d"
});
const auth = getAuth(app);
const db = getFirestore(app);

/* SESSION GUARD */
onAuthStateChanged(auth, async (user)=>{
  if(!user){ location.replace("login.html"); return; }
  const snap = await getDoc(doc(db,"users",user.uid));
  if(!snap.exists() || snap.data().role!=="admin" || snap.data().status!=="active"){
    await signOut(auth);
    location.replace("login.html");
    return;
  }
  loadStats();
  loadRecent();
});

/* LOAD STATS */
async function loadStats(){
  showLoader();

  const usersSnap = await getDocs(collection(db,"users"));
  document.getElementById("usersCount").innerText = usersSnap.size;

  const ordersSnap = await getDocs(collection(db,"orders"));
  document.getElementById("ordersCount").innerText = ordersSnap.size;

  let completed=0, revenue=0;
  ordersSnap.forEach(d=>{
    const o=d.data();
    if(o.status==="completed"){
      completed++;
      revenue += Number(o.totalAmount||0);
    }
  });

  document.getElementById("completedCount").innerText = completed;
  document.getElementById("revenue").innerText = revenue.toFixed(2);

  hideLoader();
}

/* RECENT ORDERS */
async function loadRecent(){
  const q = query(collection(db,"orders"), orderBy("createdAt","desc"), limit(5));
  const snap = await getDocs(q);
  const body = document.getElementById("recentOrders");
  body.innerHTML="";
  snap.forEach(d=>{
    const o=d.data();
    body.innerHTML += `
      <tr>
        <td>${d.id.slice(0,6)}...</td>
        <td>${o.status}</td>
        <td>â‚¹${o.totalAmount||0}</td>
      </tr>
    `;
  });
}

/* LOGOUT */
window.logout = async ()=>{
  await signOut(auth);
  location.replace("login.html");
};
</script>

</body>
</html>
